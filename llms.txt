# FamilyEye - AI Context File (llms.txt)
# This file provides essential context about the project for AI agents (LLMs, Cursor, Copilot, etc.)

================================================================================
PROJECT OVERVIEW
================================================================================

Name: FamilyEye (Parental Control Enterprise)
Type: Complete parental control solution for families
License: GPLv3 (code), CC BY-NC-SA 4.0 (images)
Repository: Monorepo structure

Purpose:
- Multi-platform parental control system
- Real-time monitoring and enforcement
- Screen time management
- Advanced content analysis (Smart Shield)
- Offline-first architecture

================================================================================
TECH STACK
================================================================================

BACKEND:
- Framework: FastAPI 0.104.1
- Database: SQLite (default), SQLAlchemy 2.0.23 ORM
- Authentication: JWT (python-jose), bcrypt (passlib)
- WebSocket: websockets 12.0
- HTTP Client: httpx 0.28.1
- Testing: pytest, pytest-asyncio
- Python: 3.8+ (production uses 3.10+)

FRONTEND:
- Framework: React 18.2.0
- Router: React Router 6.20.0
- Build Tool: Vite 5.0.8
- HTTP Client: Axios 1.6.2
- Charts: Recharts 3.6.0
- Icons: lucide-react 0.562.0
- Testing: Vitest 2.1.9
- Node.js: 18+

WINDOWS AGENT:
- Language: Python 3.x
- Key Libraries:
  - psutil 5.9.0+ (process monitoring)
  - pywin32 306+ (Windows API)
  - requests 2.31.0+ (HTTP)
  - websockets 12.0+ (real-time)
  - colorama 0.4.6+ (logging colors)

ANDROID AGENT:
- Language: Kotlin
- UI: Jetpack Compose
- DI: Hilt
- Database: Room
- Storage: DataStore
- Networking: OkHttp + Retrofit
- WebSocket: OkHttp WebSocket
- Background: WorkManager + Foreground Service
- Min SDK: 29 (Android 10)
- Target SDK: 35 (Android 15)
- ü§ñ Device Owner: Supported (Custom ≈°t√≠tek)

================================================================================
PROJECT STRUCTURE
================================================================================

Parential-Control_Enterprise/
‚îú‚îÄ‚îÄ .github/
‚îÇ   ‚îî‚îÄ‚îÄ workflows/          # CI/CD (android.yml, backend.yml, frontend.yml, release.yml)
‚îú‚îÄ‚îÄ backend/
‚îÇ   ‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api/            # REST endpoints
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.py      # Authentication (JWT)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ devices/     # Device management
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rules.py     # Rules management
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ reports/     # Statistics endpoints
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ websocket.py # Real-time WebSocket
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ shield.py    # Smart Shield
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ trust.py     # SSL certificates
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/        # Business logic
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pairing_service.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ stats_service.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ summary_service.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ insights_service.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models.py        # SQLAlchemy models
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ schemas.py       # Pydantic schemas
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.py        # Configuration
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ database.py      # DB connection
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ main.py          # FastAPI app
‚îÇ   ‚îú‚îÄ‚îÄ tests/               # Pytest tests
‚îÇ   ‚îú‚îÄ‚îÄ run_https.py         # HTTPS server launcher
‚îÇ   ‚îî‚îÄ‚îÄ requirements.txt
‚îú‚îÄ‚îÄ frontend/
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ components/      # React components
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Dashboard.jsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DeviceList.jsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RuleEditor.jsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Reports.jsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ charts/      # Chart components
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api.js       # API client
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ websocket.js # WebSocket service
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ hooks/           # Custom React hooks
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils/           # Utility functions
‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îî‚îÄ‚îÄ vite.config.js
‚îú‚îÄ‚îÄ clients/
‚îÇ   ‚îú‚îÄ‚îÄ android/             # Android Agent (Kotlin)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ app/src/main/java/com/familyeye/agent/
‚îÇ   ‚îî‚îÄ‚îÄ windows/             # Windows Agent (Python)
‚îÇ       ‚îú‚îÄ‚îÄ agent/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ main.py      # Main agent (Windows Service)
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ monitor/     # App monitoring
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ enforcer/    # Rule enforcement
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ websocket/   # WebSocket client
‚îÇ       ‚îî‚îÄ‚îÄ child_agent.py   # UI agent (user session)
‚îú‚îÄ‚îÄ docs/                    # Documentation
‚îÇ   ‚îú‚îÄ‚îÄ ARCHITECTURE.md
‚îÇ   ‚îú‚îÄ‚îÄ API.md
‚îÇ   ‚îú‚îÄ‚îÄ DEVELOPMENT.md
‚îÇ   ‚îî‚îÄ‚îÄ DEPLOYMENT.md
‚îú‚îÄ‚îÄ installer/               # Inno Setup installers
‚îÇ   ‚îú‚îÄ‚îÄ agent/               # Windows Agent installer
‚îÇ   ‚îî‚îÄ‚îÄ server/              # Backend installer
‚îú‚îÄ‚îÄ certs/                   # SSL certificates (generated)
‚îú‚îÄ‚îÄ .cursorrules             # Cursor AI instructions
‚îú‚îÄ‚îÄ LICENSE                  # GPLv3
‚îî‚îÄ‚îÄ LICENSE_IMAGES           # CC BY-NC-SA 4.0

================================================================================
ARCHITECTURE PATTERNS
================================================================================

BACKEND:
- FastAPI with dependency injection
- SQLAlchemy ORM with models
- Pydantic schemas for validation
- Service layer pattern (business logic in services/)
- RESTful API design
- WebSocket for real-time updates
- JWT authentication for parents
- API Key authentication for agents

FRONTEND:
- React functional components with hooks
- Custom hooks for data fetching (useDevices, useRules, useQuickActions)
- Component-based architecture
- Service layer (api.js, websocket.js)
- React Router for navigation
- Axios for HTTP requests

WINDOWS AGENT:
- Session 0 Service Architecture:
  - Main agent runs as Windows Service (Session 0)
  - ChildAgent runs in user session (Session 1+)
  - IPC via Named Pipes
- Modular structure:
  - monitor/ - App monitoring
  - enforcer/ - Rule enforcement
  - websocket/ - Real-time communication
- Threading for concurrent operations
- Offline queue for reports

ANDROID AGENT:
- MVVM architecture
- Repository pattern for data
- Dependency Injection (Hilt)
- Service-based background processing
- Device Owner mode for MDM capabilities
- Accessibility Service for app detection

================================================================================
CODING STANDARDS
================================================================================

PYTHON:
- PEP 8 style guide
- Type hints where possible
- Docstrings for functions/classes
- Use pathlib.Path for file operations
- Logging to C:\ProgramData\FamilyEye\Agent\Logs (Windows agent)
- Named Pipe IPC between Session 0 and user session
- UI elements ONLY in child_agent.py

JAVASCRIPT/REACT:
- ES6+ modern JavaScript
- Functional components (no class components)
- React Hooks (useState, useEffect, custom hooks)
- CSS Modules for component styling
- No console.log/debug/warn in production (only console.error for critical errors)
- Axios for HTTP (configured in services/api.js)

KOTLIN:
- Kotlin coding conventions
- Null safety (use ? and !! appropriately)
- Data classes for DTOs
- Sealed classes for state management
- Coroutines for async operations
- Extension functions for utilities

================================================================================
KEY CONVENTIONS
================================================================================

FILE NAMING:
- Python: snake_case (main.py, api_client.py)
- JavaScript: camelCase (DeviceList.jsx, useDevices.js)
- Kotlin: PascalCase for classes, camelCase for functions

IMPORTS:
- Backend: Relative imports within app/ (from ..api.auth import ...)
- Frontend: Absolute imports from src/ (import api from './services/api')
- Windows Agent: Package imports (from .monitor import AppMonitor)

CONFIGURATION:
- Backend: Environment variables + config.py
- Windows Agent: config.json (runtime, not in repo)
- Android Agent: DataStore for preferences, Room for database

LOGGING:
- Backend: Python logging module
- Windows Agent: Custom logger with colors (logger.py)
- Frontend: console.error only for critical errors
- Android Agent: Timber logging

================================================================================
BUILD & DEPLOYMENT
================================================================================

BACKEND:
- Run: python run_https.py (generates SSL certs automatically)
- Service: python service_wrapper.py install/start
- Tests: pytest tests/
- Build Installer:
  1. Build EXE: python installer/server/build_server_exe.py
  2. Compile ISS: "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "installer/server/setup_server.iss"

FRONTEND:
- Dev: npm run dev (Vite dev server)
- Build: npm run build (output: dist/)
- Tests: npm test (Vitest)

WINDOWS AGENT:
- Dev: python -m agent.main
- Build: python installer/agent/build_agent.py
- Installer: "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "installer/agent/setup_agent_2.4.0.iss"
- Service: Installed as Windows Service

ANDROID AGENT:
- Build: cd clients/android && ./gradlew.bat assembleDebug (on Windows) or ./gradlew assembleDebug (on Unix)
- APK Location: clients/android/app/build/outputs/apk/debug/app-debug.apk
- Setup Flow: Requires Pairing Token from Dashboard -> PIN Setup -> Permissions -> (Optional) Device Owner
- ü§ñ Device Owner Activation:
  1. Wipe all accounts from device (Settings -> Accounts).
  2. Connect via USB (Developer Options -> USB Debugging).
  3. Run: `adb shell dpm set-device-owner com.familyeye.agent/.receiver.FamilyEyeDeviceAdmin`
- üõ°Ô∏è Emergency Recovery (v1.0.27+):
  - "Deactivate & Unpair" button in Admin Settings allows programmatic removal of Admin/DO rights.
  - Prevents "sticky" installations during development.
- Troubleshooting: If build fails, check `clients/android/app/src/main/java/com/familyeye/agent/ui/screens/SetupWizardScreen.kt` for syntax errors.

================================================================================
API STRUCTURE
================================================================================

BASE URL: http://localhost:8000 (dev) or https://domain:8000 (prod)

AUTHENTICATION:
- Parents: POST /api/auth/login ‚Üí JWT token ‚Üí Bearer token in header
- Agents: API Key + Device ID in request body

KEY ENDPOINTS:
- POST /api/auth/login - Parent login
- POST /api/devices/pairing/token - Generate pairing token
- POST /api/devices/pairing/pair - Pair device (agent)
- GET /api/devices/ - List devices (parent)
- POST /api/rules/ - Create rule (parent)
- POST /api/rules/agent/fetch - Fetch rules (agent)
- POST /api/reports/agent/report - Report usage (agent)
- WS /api/ws/{user_id} - WebSocket for real-time updates

================================================================================
DATABASE SCHEMA
================================================================================

TABLES:
- users: Parents and children (email, password_hash, role)
- devices: Paired devices (name, device_type, device_id, api_key, parent_id)
- rules: Rules for devices (rule_type, app_name, time_limit, schedule, enabled)
- usage_logs: Usage statistics (device_id, app_name, duration, timestamp)
- pairing_tokens: Temporary pairing tokens (token, parent_id, expires_at, used)

RELATIONSHIPS:
- users (parent) ‚Üí devices (parent_id)
- devices ‚Üí rules (device_id)
- devices ‚Üí usage_logs (device_id)

================================================================================
SECURITY NOTES
================================================================================

AUTHENTICATION:
- Passwords: bcrypt hash (fallback pbkdf2_sha256)
- JWT: 24h expiration for parents
- API Keys: UUID, unique per device
- SSL: Self-signed certificates (auto-generated), CA cert for trust

COMMUNICATION:
- HTTPS: Required in production (run_https.py)
- WebSocket: WSS in production
- CORS: Configurable, restrict in production

AGENT SECURITY:
- Windows: Runs as Windows Service (elevated privileges)
- Android: Device Owner mode (requires factory reset or ADB)
- Offline queue: Reports cached when offline, synced on reconnect

================================================================================
TESTING
================================================================================

BACKEND:
- Framework: pytest
- Location: backend/tests/
- Fixtures: conftest.py (database session, test user, test device)
- Run: pytest tests/

FRONTEND:
- Framework: Vitest
- Location: frontend/src/components/*.test.jsx
- Setup: frontend/src/test/setup.js
- Run: npm test

ANDROID:
- Unit tests: clients/android/app/src/test/
- Instrumented tests: clients/android/app/src/androidTest/
- Framework: JUnit, MockK

================================================================================
IMPORTANT PATTERNS
================================================================================

OFFLINE-FIRST:
- Agents cache rules and reports locally
- Sync when connection restored
- Windows agent: report_queue.json, usage_cache.json
- Android agent: Room database + DataStore

REAL-TIME:
- WebSocket for frontend updates
- WebSocket for agent commands (screenshot, lock, refresh)
- Polling fallback if WebSocket fails

TIME SYNCHRONIZATION:
- Backend provides UTC time
- Agents sync time on connection
- Daily reset based on local time
- Usage tracking uses monotonic time for accuracy

DEVICE OWNER (Android):
- ü§ñ Device Owner: Supported (Custom ≈°t√≠tek)
- Required for full MDM capabilities
- Set via: adb shell dpm set-device-owner
- Prevents uninstall, enables advanced controls
- Requires factory reset or ADB provisioning

================================================================================
COMMON TASKS
================================================================================

ADD NEW API ENDPOINT:
1. Create router in backend/app/api/
2. Add endpoint with decorator
3. Register in backend/app/main.py
4. Update docs/API.md

ADD NEW RULE TYPE:
1. Add rule_type to Rule model
2. Implement in clients/windows/agent/enforcer/core.py
3. Add UI in frontend/src/components/RuleEditor.jsx
4. Update API endpoint

ADD NEW FRONTEND COMPONENT:
1. Create in frontend/src/components/
2. Add CSS file
3. Import and use in App.jsx or parent component
4. Update docs/FRONTEND.md if significant

PAIR NEW DEVICE:
1. Parent creates pairing token (POST /api/devices/pairing/token)
2. Agent sends pairing request (POST /api/devices/pairing/pair)
3. Backend creates device, returns api_key
4. Agent saves config.json with api_key

================================================================================
KNOWN LIMITATIONS
================================================================================

- SQLite database (single-file, not for high concurrency)
- Self-signed SSL certificates (user must trust CA)
- Windows agent requires admin privileges
- Android Device Owner requires factory reset or ADB
- No multi-tenant support (single parent account)
- In-memory WebSocket connections (no persistence)

================================================================================
END OF CONTEXT
================================================================================
